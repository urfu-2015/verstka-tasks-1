<html lang="ru">
<body>
<title>Блог компании Яндекс.</title>
<p style="text-align: center"><h1>ЯНДЕКС.ПОЧТА: КАК МЫ ИЗМЕРЯЕМ СКОРОСТЬ ЗАГРУЗКИ И УЛУЧШАЕМ ЕЁ.</h1></p>
<p>Если ваш сайт медленно грузится, вы рискуете тем, что люди не оценят ни то,какой он красивый, 
ни то, какой он удобный. Никому не понравится, когда все тормозит. Мы регулярно добавляем в Яндекс.Почту 
новую функциональность, иногда — исправляем ошибки, а это значит, у нас постоянно появляются новый код
и новая логика. Всё это напрямую влияет на скорость работы интерфейса.</p>

<section>
<p><h2>Что мы измеряем</h2></p>
<p><h3>Этапы первой загрузки:</h3></p>
	<ul>
		<li> подготовка;</li>
		<li> загрузка статики (HTTP-запрос и парсинг);</li>
		<li> исполнение модулей;</li>
		<li> инициализация базовых объектов;</li>
		<li> отрисовка.</li>
	</ul>
<p><h3>Этапы отрисовки любой страницы:</h3></p>
	<ol>
		<li>подготовка к запросу на сервер;</li>
		<li>запрос данных с сервера;</li>
		<li>шаблонизация;</li>
		<li>обновление DOM.</li>
	</ol>
<blockquote>
	<q>Ок, теперь у нас есть метрики, мы можем отправить их на сервер</q> - говорим мы.<br>
	<q>Что же дальше?</q> - вопрошаете. <br>
	<q>А давай построим график!</q> - отвечаем. <br>
	<q>А что будем считать?</q> - уточняете. <br>
</blockquote>
<p>Как вы знаете, <dfn>медиана</dfn> – это серединное, а не среднее значение в выборке.
Если у нас имеются числа 1, 2, 2, 3, 8, 10, 20, то медиана – 3, а среднее – 6,5.
В общем случае медиана отлично показывает, сколько грузится средний пользователь.</p>
<p>В случае ускорения или замедления медиана, конечно, изменится. Но она не может
рассказать, сколько пользователей ускорилось, а сколько замедлилось.</p>
<p><abbr title="Application Performance Index">APDEX</abbr> – метрика, которая сразу говорит: хорошо или плохо. 
Метрика работает очень просто. Мы выбираем временной интервал [0; t], такой, что если время показа страницы попало
в него, то пользователь счастлив. Берем еще один интервал, (t; 4t] (в четыре раза больше первого), и считаем, что 
если страница показана за это время, то пользователь в целом удовлетворен скоростью работы,но уже не настолько счастлив. 
И применяем формулу:<br></p>
<big><math xmlns="http://www.w3.org/1998/Math/MathML">
	<mfrac>
		<mrow><mi>(кол-во счастливых пользователей</mi> <mo>+</mo> <mi>кол-во удовлетворенных)</mi> <mo>/</mo> <mi>2</mi></mrow>
		<mrow><mi>кол-во всех</mi></mrow>
	</mfrac>
</math>.</big>
<p>Получается значение от нуля до единицы, которое, видимо, лучше всего показывает, хорошо или плохо работает почта.</p>
</section>

<section>
<p><h2>Как мы измеряем</h2></p>
<p>Сейчас модуль обновления сам логирует все свои стадии, и можно легко понять причину замедления: медленнее стал 
отвечать сервер либо слишком долго выполняется JavaScript. Выглядит это примерно так:</p>
<pre><code>this.timings['look-ma-im-start'] = Date.now();
this.timings['look-ma-finish'] = Date.now();</code></pre>
<p>C помощью <code>Date.now()</code> мы получаем текущее время. Все тайминги собираются и при отправке рассчитываются.
 На этапах разница между “end” и “start” не считается, а все вычисления производятся в конце:</p>
<pre><code>var totalTime = this.timings['look-ma-finish'] - this.timings['look-ma-im-start'];</code></pre>
<p>И на сервер прилетают подобные записи:</p>
<p><code>serverResponse=50&domUpdate=60</code></p>
</section>

<section>
<p><h2>Как мы ускоряем</h2></p>

<p>Чтобы снизить время загрузки почты при выходе новых версий, мы уже делаем следующее:</p>
<ul>
	<li> включаем gzip;</li>
	<li> выставляем заголовки кэширования;</li>
	<li> фризим CSS, JS, шаблоны и картинки;</li>
	<li> используем CDN;</li>
</ul>
<p>Мы подумали: <blockquote>А что если хранить где-то старую версию файлов, а при выходе новой передавать только 
diff между ней и той, которая сохранена у пользователя?</blockquote> В браузере же останется просто наложить патч на клиенте.</p>

<p>На самое деле эта идея не нова. Уже существуют стандарты для HTTP — например, RFC 3229 «Delta encoding in HTTP» 
и «Google SDHC», — но по разным причинам они не получили должного распространения в браузерах и на серверах.</p>

<p>Мы же решили сделать свой аналог на JS. Чтобы реализовать этот метод обновления, начали искать реализации
diff на JS. На популярных хостингах кода нашли библиотеки:</p>
<ul>
	<li>VCDiff</li>
	<li>google-diff-patch-match</li>
</ul>
<p>Для окончательного выбора библиотеки нам нужно сравнить:</p>
<pre>Библиотека      | IE 9          | Opera 12
----------      | ----          | --------
vcdiff          | 8             | 5
google diff     | 1363          | 76</pre>
<p>После того как мы определились с библиотекой для диффа, нужно определиться с тем, где и как хранить статику на клиенте.</p>

<p>Формат файла с патчами для проекта выглядит так:</p>
<pre><code>[
    {
        "k": "jane.css",
        "p": [patch],
        "s": 4554
    },
    {
        "k": "jane.css",
        "p": [patch],
        "s": 4554
    }
]</code></pre>
<p>То есть это обычный массив из объектов. Каждый объект — отдельный ресурс. У каждого объекта есть три свойства. 
k — названия ключа в localStorage для этого ресурса. p — патч для ресурса, который сгенерировал vcdiff. s — чексумма
для ресурса актуальной версии, чтобы потом можно было проверить правильность наложения патча на клиенте. Чексумма 
вычисляется по алгоритму Флетчера.</p>
<p><dl>
<dt><em>Алгоритм Бройдена — Флетчера — Гольдфарба — Шанно (<abbr title="Broyden–Fletcher–Goldfarb–Shanno algorithm">BFGS</abbr>)</em></dt>
<dd>итерационный метод численной оптимизации, предназначенный для нахождения локального максимума/минимума нелинейного функционала
без ограничений.</dd></dl></p>
<pre>
	Дано &epsilon;,&chi;<sub>0</sub>
	Инициализировать H<sub>0</sub>
	k=0 
	<code>while</code> ||&nabla;&fnof;<sub>k</sub>||>&epsilon;
	   найти направление &rho;<sub>k</sub>=-С<sub>k</sub>&nabla;&fnof;<sub>k</sub>
	   вычислить &chi;<sub>k+1</sub>=&chi;<sub>k</sub>+&alpha;<sub>k</sub>&rho;<sub>k</sub>, &alpha;<sub>k</sub> удовлетворяет условиям Вольфе
	   обозначить s<sub>k</sub>=&chi;<sub>k+1</sub>-&chi;<sub>k</sub> и y<sub>k</sub>=&nabla;&fnof;<sub>k+1</sub>-&nabla;&fnof;<sub>k</sub>
	   вычислить C<sub>k+1</sub>
	   k=k+1
	end
</pre>
<p>Почему именно алгоритм Флетчера, а не другие популярные алгоритмы вроде:</p>
<dl><dt><em>CRC16/32</em></dt> 
<dd>алгоритм нахождения контрольной суммы, предназначенный для проверки целостности данных.</dd>
<dt><em>md5</em></dt> 
<dd>128-битный алгоритм хеширования. Предназначен для создания «отпечатков» или дайджестов сообщения произвольной длины и последующей проверки
их подлинности.</dd></dl>
<p>Потому что он быстрый, компактный и легок в реализации.</p>
</section>

<section>
<p><h2>Итог</h2></p>
<p>Фактически мы экономим 80-90% трафика. Размер загружаемой статитки в байтах:</p>
<pre>Релиз  | С патчем     | Без патча
7.7.20  | 397          | 174 549
7.7.21  | 383          | 53 995
7.7.22  | 483          | 3 995</pre>
<p>Автор: @doochik<br>
С++ разработик
<address>Электронная почта: <a href>doochik@yandex-team.ru</a></address>
Компания: Яндекс<br></p>
</section>

<section>
<h2>Комментарии (3):</h2>

<article>- Mogaika (<a href>mogaika@yandex-team.ru</a>) <time>30 ноября 2014 в 17:05</time>
<blockquote>А можете привести сравнение, на сколько быстрее грузится lite версия?</blockquote></article>

<article>- JIguse (<a href>mrawesome@yandex.ru</a>) <time>29 ноября 2014 в 21:30</time>
<blockquote>Спасибо за статью, познавательно. Здорово, что Яндекс делится некоторыми
подробностями о внутренней работе сервисов.</blockquote></article>

<article>- Brister (<a href>brist89@yandex-team.ru</a>) <time>24 ноября 2014 в 13:13</time><br>
<blockquote><blockquote>
<math xmlns="http://www.w3.org/1998/Math/MathML">
<mfrac>
<mrow>
<mi>(кол-во счастливых пользователей</mi> <mo>+</mo> <mi>кол-во удовлетворенных)</mi> <mo>/</mo> <mi>2</mi> 
</mrow>
<mrow><mi>кол-во всех</mi></mrow>
</mfrac>
</math>	<br>
Получается значение от нуля до единицы, которое, видимо, лучше всего показывает, хорошо или плохо работает почта.</blockquote>
наверное все-таки от 0.5 до 1</blockquote>
</article>

<article>- alexeimois (<a href>test@yandex.ru</a>) 22 ноября 2014 в 17:35<br>
<blockquote>Мы измеряем скорость загрузки с помощью Яндекс.Метрики:<br><a href>help.yandex.ru</a></blockquote>
</article>
</section>

<hr>
<footer>© Яндекс, <a href>help@yandex.ru</a>, Хохрякова, 10</footer>
</body>
</html>
